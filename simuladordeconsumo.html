<!DOCTYPE html>
<html lang="pt-PT">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" href="./image/icon6.png" type="image/png" sizes="128x128">
  <title>Simulador de Consumo — PDF</title>
  <style>
    :root{
      --maxw:980px;
      --accent:#2b6cb0;
      --bg:#f7f9fb;
      --muted:#555;
      --header:#0077b6;
      --cta:#0077b6;
      --card-shadow: 0 8px 30px rgba(15,15,15,0.07);
    }
    *{box-sizing:border-box}
    body{
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      background:var(--bg);
      padding:2rem;
      display:flex;
      justify-content:center;
      -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
    }
    .card{width:100%;max-width:var(--maxw);background:#fff;border-radius:8px;padding:1.25rem;box-shadow:var(--card-shadow);}
    h1{margin:0 0 .25rem;color:var(--accent)}
    p.lead{margin:0 0 1rem;color:var(--muted)}
    form{display:grid;gap:0.75rem}
    .row{display:flex;gap:0.75rem}
    .col{flex:1}
    label{display:block;font-weight:600;font-size:.92rem;margin-bottom:.25rem}
    input[type="text"], input[type="email"], input[type="number"], select, textarea {width:100%;padding:.6rem;border:1px solid #e2e8f0;border-radius:6px;font-size:.95rem;background:#fff;}
    textarea{min-height:120px;resize:vertical}
    .small{font-size:.86rem;color:var(--muted);margin-top:.25rem}
    .controls{display:flex;gap:.5rem;align-items:center;margin-top:.5rem;flex-wrap:wrap}
    button{background:var(--accent);color:#fff;border:none;padding:.6rem .9rem;border-radius:6px;cursor:pointer}
    button.secondary{background:#4a5568}
    .status{margin-left: .5rem;font-size:.95rem;color:var(--muted)}
    .consent{display:flex;gap:.5rem;align-items:center}
    .notice{font-size:.9rem;color:#bf2e2e}
    .success{color:green}
    .error{color:#bf2e2e}
    footer{margin-top:1rem;font-size:.85rem;color:var(--muted)}
    @media(max-width:700px){.row{flex-direction:column}}
    #title {background: var(--header);color: white;text-align: center;padding: 22px 0;font-size: 26px;font-weight: bold;margin-left: -15px; margin-right: -15px;font-family: Cambria, Cochin, Georgia, Times, 'Times New Roman', serif;border-top-left-radius:8px; border-top-right-radius:8px;}
    #lead{ text-align: center; justify-content: center; margin-bottom: 12px; }
    .grid {display:grid;grid-template-columns: 1fr 420px;gap:18px;margin-top:12px;}
    @media(max-width:1000px){ .grid { grid-template-columns: 1fr; } }
    .panel { background:#fff; border-radius:8px; padding:14px; border:1px solid #eef2f6; box-shadow: 0 6px 18px rgba(10,10,10,0.03); }
    .panel h3 { margin:0 0 8px; color:var(--header); font-size:1.05rem; }
    .muted { color:var(--muted); font-size:0.95rem; }
    .form-row { display:flex; gap:10px; }
    .form-row .field { flex:1; }
    .result { margin-top:10px; padding:12px; border-radius:8px; background: linear-gradient(180deg,#fbfbfb,#fff); border:1px solid #eee; font-size:1rem; line-height:1.6; }
    .result p { margin:6px 0; font-size:15px; }
    .helper { font-size:0.88rem; color:var(--muted); margin-top:6px; }
    .charcount { font-size:0.85rem; color:var(--muted); text-align:right; }
    footer {background:var(--header); color:white; padding:1.6rem 1rem; margin-top:1.25rem; margin-left: -15px; margin-right: -15px; border-bottom-left-radius:8px; border-bottom-right-radius:8px;}
    .footer1 {text-align:center; margin-bottom:0.6rem;}
    .footer1 h3 {margin-bottom:0.5rem; font-size:1.05rem;}
    .footer1 ul {display:flex; gap:12px; justify-content:center; flex-wrap:wrap; padding:0; margin:0;}
    .footer1 li a {color:white; padding:6px 12px; border-radius:6px; background:var(--cta); transition:0.3s; text-decoration:none; font-weight:600;}
    .footer1 li a:hover {background:#18a8c5;}
    .footer-bottom {text-align:center; font-size:0.9rem; margin-top:0.8rem;}
    .footer1 li{list-style-type: none;}
    input:focus, select:focus, textarea:focus, button:focus { outline:3px solid rgba(0,123,255,0.15); outline-offset:2px; }
    .muted-small { color: #6b7280; font-size:0.9rem; }
  </style>
</head>
<body>
  <main class="card" role="main" aria-labelledby="title">
    <h1 id="title">Simulador de Consumo</h1>
    <p class="lead" id="lead">Calcula o consumo e o valor a pagar, com discriminação do imposto. Pode guardar o relatório em PDF.</p>

    <div class="grid">
      <!-- Left: explicação + dados pessoais -->
      <section class="panel" aria-labelledby="howTitle">
        <h3 id="howTitle">Como funciona &amp; Dados pessoais</h3>
        <p class="muted">O simulador converte litros em m³, aplica um factor de perdas (opcional), calcula o valor sem imposto pela tarifa por m³ e depois aplica a taxa de imposto. Preencha os seus dados pessoais se deseja incluí-los no relatório de impressão/PDF.</p>
        <hr style="margin:10px 0">
        <h4 style="color:var(--cta); margin:8px 0;">Dados pessoais (opcional)</h4>

        <div class="form-row">
          <div class="field"><label for="userName">Nome completo</label><input id="userName" type="text" placeholder="Ex.: Maria Silva"></div>
          <div class="field"><label for="userBI">BI</label><input id="userBI" type="text" placeholder="Ex.: A1234567"></div>
        </div>
        <div class="form-row" style="margin-top:8px;">
          <div class="field"><label for="province">Província</label><input id="province" type="text" placeholder="Ex.: Maputo"></div>
          <div class="field"><label for="district">Distrito</label><input id="district" type="text" placeholder="Ex.: Matola"></div>
        </div>
        <div style="margin-top:8px;">
          <label for="bairro">Bairro</label><input id="bairro" type="text" placeholder="Ex.: Bairro Central">
        </div>
        <div class="form-row" style="margin-top:8px;">
          <div class="field"><label for="userPhone">Telefone</label><input id="userPhone" type="text" placeholder="+258 8xx xxx xxx"></div>
          <div class="field"><label for="userEmail">Email</label><input id="userEmail" type="email" placeholder="exemplo@dominio.com"></div>
        </div>
        <div class="form-row" style="margin-top:8px;">
          <div class="field"><label for="userAddress">Morada (rua / número)</label><input id="userAddress" type="text" placeholder="Rua, Bairro, Cidade"></div>
          <div class="field"><label for="ownerStatus">És proprietário?</label>
            <select id="ownerStatus">
              <option value="">— Seleciona —</option>
              <option value="Sim">Sim — Proprietário</option>
              <option value="Não">Não — Arrendatário / Outro</option>
            </select>
          </div>
        </div>

        <div style="margin-top:8px;" class="consent">
          <input id="includePersonal" type="checkbox" />
          <label for="includePersonal" class="muted-small">Incluir dados pessoais no relatório PDF</label>
        </div>

        <div class="controls" style="margin-top:8px;">
          <button type="button" id="clearPersonalBtn" class="secondary">Limpar Dados Pessoais</button>
        </div>

        <div style="margin-top:12px;" class="helper">
          <strong>Privacidade:</strong> Os dados pessoais inseridos são usados apenas localmente para gerar o PDF. Não são enviados para lado nenhum a menos que tu o faças.
        </div>
      </section>

      <!-- Right: calculadora -->
      <aside class="panel" aria-labelledby="calcTitle">
        <h3 id="calcTitle">Calculadora</h3>
        <form id="simForm" onsubmit="return false;" aria-describedby="formDesc">
          <div id="formDesc" class="helper">Preenche os campos e clica em <strong>Calcular</strong>.</div>
          <div class="form-row" style="margin-top:10px;">
            <div class="field"><label for="residents">Número de residentes</label><input id="residents" type="number" min="1" step="1" value="4" required aria-required="true"></div>
            <div class="field"><label for="litersPerPerson">Consumo diário por pessoa (L)</label><input id="litersPerPerson" type="number" min="1" step="1" value="150" required></div>
          </div>
          <div class="form-row" style="margin-top:8px;">
            <div class="field"><label for="days">Dias (período)</label><input id="days" type="number" min="1" max="366" step="1" value="30" required></div>
            <div class="field"><label for="tariff">Tarifa por m³ (MT)</label><input id="tariff" type="number" min="0" step="0.01" value="22.80" required></div>
          </div>
          <div class="form-row" style="margin-top:8px;">
            <div class="field"><label for="lossFactor">Fator de perda / reserva (%)</label><input id="lossFactor" type="number" min="0" max="100" step="0.1" value="0"></div>
            <div class="field"><label for="taxRate">Taxa de imposto (%)</label><input id="taxRate" type="number" min="0" max="100" step="0.01" value="12.75"></div>
          </div>
          <div style="margin-top:10px;">
            <label for="note">Nota (opcional)</label>
            <textarea id="note" placeholder="Ex.: período considerado, observações..."></textarea>
            <div class="charcount" id="charcount">0 / 500</div>
          </div>
          <div class="controls" style="margin-top:12px;">
            <button id="calcBtn" type="button">Calcular</button>
            <button id="resetBtn" class="secondary" type="button">Limpar</button>
            <button id="copyBtn" class="secondary" type="button" title="Copiar resultado">Copiar Resultado</button>
            <button id="sendEmailBtn" class="secondary" type="button" title="Enviar Nota por Email">Enviar Nota por Email</button>
            <button id="savePdfBtn" class="secondary" type="button" title="Guardar PDF">Guardar PDF</button>
            <div id="status" class="status" role="status" aria-live="polite"></div>
          </div>
          <div class="result" id="resultBox" aria-live="polite" style="display:none;">
            <p id="lineConsumption"><strong>O consumo é de:</strong> <span class="muted">—</span></p>
            <p id="lineValueNoTax"><strong>Valor a pagar sem imposto:</strong> <span class="muted">—</span></p>
            <p id="lineTax"><strong>Imposto:</strong> <span class="muted">—</span></p>
            <p id="lineTotal"><strong>Valor Total a pagar incluindo o Imposto:</strong> <span class="muted">—</span></p>
            <p id="resNote" class="muted" style="margin-top:8px"></p>
          </div>
        </form>
      </aside>
    </div>

    <footer>
      <div class="footer1">
        <h3>Siga-nos em:</h3>
        <ul>
          <li><a href="https://www.facebook.com/fipag/?locale=pt_BR" target="_blank" rel="noopener">Facebook</a></li>
          <li><a href="https://x.com/fipagmoz" target="_blank" rel="noopener">Twitter / X</a></li>
          <li><a href="https://www.instagram.com/fipag/" target="_blank" rel="noopener">Instagram</a></li>
        </ul>
      </div>
      <div class="footer-bottom">© 2025 FIPAG - Fundo de Investimento e Património do Abastecimento de Água</div>
    </footer>
  </main>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

  <script>
  (function(){
    const $ = id => document.getElementById(id);
    const calcBtn = $('calcBtn');
    const resetBtn = $('resetBtn');
    const copyBtn = $('copyBtn');
    const sendEmailBtn = $('sendEmailBtn');
    const savePdfBtn = $('savePdfBtn');
    const clearPersonalBtn = $('clearPersonalBtn');
    const resultBox = $('resultBox');
    const lineConsumption = $('lineConsumption');
    const lineValueNoTax = $('lineValueNoTax');
    const lineTax = $('lineTax');
    const lineTotal = $('lineTotal');
    const resNote = $('resNote');
    const charcount = $('charcount');
    const note = $('note');
    const statusBox = $('status');

    function showStatus(msg,type='') {
      statusBox.textContent = msg;
      statusBox.className = 'status ' + (type || '');
    }

    // --- Persistência de dados pessoais ---
    const personalFields = ['userName','userBI','province','district','bairro','userPhone','userEmail','userAddress','ownerStatus'];
    // carregar dados
    personalFields.forEach(id => {
      const val = localStorage.getItem(id);
      if(val) $(id).value = val;
      $(id).addEventListener('input', e => localStorage.setItem(id, e.target.value));
      $(id).addEventListener('change', e => localStorage.setItem(id, e.target.value));
    });
    // botão limpar dados pessoais
    clearPersonalBtn.addEventListener('click', ()=>{
      personalFields.forEach(id => { $(id).value=''; localStorage.removeItem(id); });
      $('includePersonal').checked=false;
      showStatus('Dados pessoais limpos','');
    });

    note.addEventListener('input', ()=>{ charcount.textContent = `${note.value.length} / 500`; });

    function calculate(){
      const residents = parseFloat($('residents').value)||0;
      const litersPerPerson = parseFloat($('litersPerPerson').value)||0;
      const days = parseFloat($('days').value)||0;
      const tariff = parseFloat($('tariff').value)||0;
      const lossFactor = parseFloat($('lossFactor').value)||0;
      const taxRate = parseFloat($('taxRate').value)||0;

      const totalLiters = residents * litersPerPerson * days;
      const totalM3 = totalLiters / 1000 * (1 + lossFactor/100);
      const valueNoTax = totalM3 * tariff;
      const tax = valueNoTax * taxRate/100;
      const total = valueNoTax + tax;

      lineConsumption.querySelector('span').textContent = totalM3.toFixed(3) + ' m³';
      lineValueNoTax.querySelector('span').textContent = valueNoTax.toFixed(2) + ' MT';
      lineTax.querySelector('span').textContent = tax.toFixed(2) + ' MT';
      lineTotal.querySelector('span').textContent = total.toFixed(2) + ' MT';

      resNote.textContent = note.value.trim();
      resultBox.style.display='block';
      showStatus('Cálculo concluído','success');
    }

    function buildReportElementForPdf(){
      const container = document.createElement('div');
      container.style.padding='20px';
      container.style.fontFamily='Arial, sans-serif';
      container.innerHTML = `
        <h2>Relatório do Simulador de Consumo</h2>
        ${$('includePersonal').checked ? `
        <h3>Dados Pessoais</h3>
        <p>Nome: ${$('userName').value}</p>
        <p>BI: ${$('userBI').value}</p>
        <p>Província: ${$('province').value}</p>
        <p>Distrito: ${$('district').value}</p>
        <p>Bairro: ${$('bairro').value}</p>
        <p>Telefone: ${$('userPhone').value}</p>
        <p>Email: ${$('userEmail').value}</p>
        <p>Morada: ${$('userAddress').value}</p>
        <p>Proprietário: ${$('ownerStatus').value}</p>
        `:''}
        <h3>Resultados do Consumo</h3>
        <p>${lineConsumption.textContent}</p>
        <p>${lineValueNoTax.textContent}</p>
        <p>${lineTax.textContent}</p>
        <p>${lineTotal.textContent}</p>
        ${note.value.trim() ? `<h4>Nota:</h4><p>${note.value}</p>` : ''}
      `;
      return container;
    }

    function generateFilename(){
      const now = new Date();
      return `Relatorio_Consumo_${now.getFullYear()}${now.getMonth()+1}${now.getDate()}_${now.getHours()}${now.getMinutes()}.pdf`;
    }

    calcBtn.addEventListener('click', calculate);
    resetBtn.addEventListener('click', ()=>{ $('simForm').reset(); resultBox.style.display='none'; showStatus('Campos limpos',''); charcount.textContent='0 / 500'; });

    copyBtn.addEventListener('click', ()=>{
      if(resultBox.style.display==='none'){ alert('Calcula primeiro.'); return; }
      let text = `${lineConsumption.textContent}\n${lineValueNoTax.textContent}\n${lineTax.textContent}\n${lineTotal.textContent}\n${note.value}`;
      navigator.clipboard.writeText(text).then(()=>showStatus('Resultado copiado','success'));
    });

    sendEmailBtn.addEventListener('click', function(){
      const noteText = note.value.trim();
      if(!noteText){ alert('A nota está vazia.'); return; }
      const to = 'info@fipag.co.mz';
      const subject = encodeURIComponent('Nota — Simulador de Consumo');
      const now = new Date();
      const body = encodeURIComponent(`Nota (enviada pelo Simulador de Consumo):\n\n${noteText}\n\nEmitido em: ${now.toLocaleString()}`);
      window.location.href = `mailto:${to}?subject=${subject}&body=${body}`;
    });

    savePdfBtn.addEventListener('click', async function(){
      if(resultBox.style.display==='none'){ alert('Não há resultado. Calcula primeiro.'); return; }
      showStatus('A preparar PDF...');
      try {
        const reportEl = buildReportElementForPdf();
        document.body.appendChild(reportEl);
        await html2pdf().set({
          margin:[10,10,10,10],
          filename:generateFilename(),
          image:{type:'jpeg',quality:0.98},
          html2canvas:{scale:2,useCORS:true},
          jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}
        }).from(reportEl).save();
        document.body.removeChild(reportEl);
        showStatus('PDF gerado com sucesso','success');
      } catch(err){
        console.error(err);
        showStatus('Erro ao gerar PDF','error');
      }
    });
  })();
  </script>
</body>
</html>
